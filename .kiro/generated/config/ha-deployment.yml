# High Availability Deployment Configuration
# Requirements: REQ-010 (all 5 acceptance criteria)
# Test Cases: TC-028, TC-029, TC-030

version: '3.8'

services:
  # Agent Instance 1 (Primary)
  agent-primary:
    image: durion-agent-framework:latest
    container_name: agent-primary
    environment:
      - AGENT_INSTANCE_ID=primary
      - AGENT_ROLE=primary
      - HEALTH_CHECK_INTERVAL=5s
      - FAILOVER_TIMEOUT=30s
      - BACKUP_SCHEDULE=0 */4 * * *  # Every 4 hours
    volumes:
      - agent-data-primary:/data
      - agent-backup:/backup
    networks:
      - agent-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  # Agent Instance 2 (Secondary)
  agent-secondary:
    image: durion-agent-framework:latest
    container_name: agent-secondary
    environment:
      - AGENT_INSTANCE_ID=secondary
      - AGENT_ROLE=secondary
      - HEALTH_CHECK_INTERVAL=5s
      - FAILOVER_TIMEOUT=30s
      - BACKUP_SCHEDULE=0 */4 * * *
    volumes:
      - agent-data-secondary:/data
      - agent-backup:/backup
    networks:
      - agent-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  # Load Balancer
  load-balancer:
    image: nginx:alpine
    container_name: agent-load-balancer
    ports:
      - "8080:80"
    volumes:
      - ./nginx-ha.conf:/etc/nginx/nginx.conf:ro
    networks:
      - agent-network
    depends_on:
      - agent-primary
      - agent-secondary
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Backup Service
  backup-service:
    image: durion-backup:latest
    container_name: agent-backup-service
    environment:
      - BACKUP_INTERVAL=4h
      - RETENTION_DAYS=30
      - CONSISTENCY_CHECK=true
    volumes:
      - agent-data-primary:/source/primary:ro
      - agent-data-secondary:/source/secondary:ro
      - agent-backup:/backup
    networks:
      - agent-network
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  agent-data-primary:
    driver: local
  agent-data-secondary:
    driver: local
  agent-backup:
    driver: local

networks:
  agent-network:
    driver: bridge
